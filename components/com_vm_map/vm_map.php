<?php/*------------------------------------------------------------------------ * com_vm_map - Virtuemart 2 sitemap Generator * ------------------------------------------------------------------------ * St42 - P. Kohl * copyright Copyright (C) 2011 st42.fr. All Rights Reserved. * @license - http://www.gnu.org/licenses/gpl-2.0.html GNU/GPL * Websites: http://www.st42.fr  */defined('_JEXEC') or die('');$time_pre = microtime(true);if (!class_exists( 'VmConfig' )) require(JPATH_ADMINISTRATOR .'/components/com_virtuemart/helpers/config.php');VmConfig::loadConfig();$app = JFactory::getApplication();$db  = JFactory::getDBO();$root= JURI::getInstance()->toString(  array( 'scheme', 'host') );// check if we can use standard category SEF URLS, Joomla sef and vm sef must be enable$sef = JFactory::getApplication()->getRouter()->getMode();if ( VmConfig::get('seo_disabled', false) ) $sef = false;if ($sef) {	// add vm suffix and joomla suffix if sef	$suffix = VmConfig::get('seo_sufix', '-detail');	if ($hasSuffix = $app->get('sef_suffix')) $suffix .='.html';	} else $suffix = '';$Z = "+00:00";ob_end_clean();header('Content-type: text/xml; charset=utf-8');echo '<?xml version="1.0" encoding="UTF-8"?>' ;?><urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"><?php// categories loop$q= 'SELECT c.modified_on,c.virtuemart_category_id FROM `#__virtuemart_categories_'.VMLANG.'` as cl	LEFT JOIN `#__virtuemart_categories` as c on cl.virtuemart_category_id = c.virtuemart_category_id	WHERE c.published = 1';$db->setQuery($q);$categories=$db->loadObjectList();$catRoutes = array(); foreach($categories as $row) {	// 2013-11-02 17:13:32	// 1970-01-01T00:33:33+00:00	$row->modified_on[10] = "T";	$url = $root.jRoute::_('index.php?option=com_virtuemart&view=category&virtuemart_category_id=' . $row->virtuemart_category_id,true);		if ($hasSuffix) $catRoutes[$row->virtuemart_category_id] = substr($url, 0, -5);	else $catRoutes[$row->virtuemart_category_id] = $url;	?><url><loc><?php echo $url; ?></loc><lastmod><?php echo $row->modified_on.$Z ?></lastmod><changefreq>weekly</changefreq><priority>0.5</priority></url><?php } // unset($categories);// products loop$q= 'SELECT p.modified_on,pc.virtuemart_category_id,p.virtuemart_product_id,pl.slug FROM `#__virtuemart_categories` as c	LEFT JOIN `#__virtuemart_product_categories` as pc on pc.virtuemart_category_id = c.virtuemart_category_id	LEFT JOIN `#__virtuemart_products_'.VMLANG.'` as pl on pl.virtuemart_product_id = pc.virtuemart_product_id	LEFT JOIN `#__virtuemart_products` as p on p.virtuemart_product_id = pc.virtuemart_product_id	WHERE p.published = 1 AND c.published = 1 GROUP BY p.virtuemart_product_id';$db->setQuery($q);// echo $q; jexit();$products=$db->loadObjectList();echo $db->getErrorMsg();foreach($products as $row) {	$row->modified_on[10] = "T";	if ($sef) $slug = $catRoutes[$row->virtuemart_category_id].'/'.$row->slug.$suffix;	else $slug = $root.jRoute::_('index.php?option=com_virtuemart&view=productdetails&virtuemart_product_id=' . $row->virtuemart_product_id.'&virtuemart_category_id=' . $row->virtuemart_category_id, true);	?><url><loc><?php echo $slug ?></loc><lastmod><?php echo $row->modified_on.$Z  ?></lastmod><changefreq>daily</changefreq><priority>0.8</priority></url><?php } $time_post = microtime(true);$exec_time = $time_post - $time_pre;?><!--<info><?php echo $exec_time .' '.count($products) .' '. count($categories) ?></info>--></urlset><?php jexit();